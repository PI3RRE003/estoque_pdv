<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cupom Venda #<%= @sale.id.to_s.rjust(6, '0') %></title>
  <style>
    body { 
      width: 80mm; 
      margin: 0; 
      padding: 10px; 
      font-family: 'Courier New', monospace; 
      font-size: 12px; 
      line-height: 1.2;
      color: #000;
    }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .bold { font-weight: bold; }
    .dashed { border-bottom: 1px dashed #000; margin: 8px 0; }
    table { width: 100%; border-collapse: collapse; }
    .footer { margin-top: 20px; font-size: 10px; }
    
    @media print {
      .no-print { display: none; }
      body { width: 80mm; background: white; }
      @page { margin: 0; }
    }
  </style>
</head>
<body onload="window.print();">

  <div class="no-print" style="background: #fdf6e3; padding: 10px; margin-bottom: 20px; border: 1px solid #eee; text-align: center;">
    <%= link_to "← VOLTAR PARA O PDV", new_sale_path, style: "font-weight:bold; color: #d97706; text-decoration:none;" %>
  </div>

  <div class="text-center bold" style="font-size: 16px;">ORDEM SUPLEMENTOS</div>
  <div class="text-center">CNPJ: 63.368.423/0001-89</div>
  <div class="text-center">R. Pompílio Brandão - Centro</div>
  
  <div class="dashed"></div>
  
  <div class="bold uppercase">CUPOM DE VENDA: <%= @sale.id.to_s.rjust(6, '0') %></div>
  <div>DATA: <%= @sale.created_at.strftime("%d/%m/%Y %H:%M") %></div>
  
  <div>ATENDENTE: <%= @sale.user&.name&.upcase || "NAO INFORMADO" %></div>
  
  <div class="dashed"></div>

  <div class="bold">CLIENTE:</div>
  <div>
    <% if @sale.client.present? %>
      <%= @sale.client.name.upcase %><br>
      CPF: <%= @sale.client.cpf %>
    <% else %>
      *** CONSUMIDOR FINAL ***
    <% end %>
  </div>
  
  <div class="dashed"></div>
  
  <table>
    <thead>
      <tr class="bold">
        <th align="left">ITEM</th>
        <th align="center">QTD</th>
        <th align="right">TOTAL</th>
      </tr>
    </thead>
    <tbody>
      <% @sale.sale_items.each do |item| %>
        <tr>
          <td><%= item.product.name.truncate(18).upcase %></td>
          <td align="center"><%= item.quantity %></td>
          <%# Usando o cálculo direto para evitar o erro total_price se o model não tiver o método %>
          <td align="right"><%= number_to_currency(item.quantity * item.price, unit: "") %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  
  <div class="dashed"></div>
  
  <table>
    <% subtotal = @sale.sale_items.sum { |i| i.quantity * i.price } %>
    <tr>
      <td>SUBTOTAL:</td>
      <td class="text-right"><%= number_to_currency(subtotal) %></td>
    </tr>
    
    <% if @sale.discount.to_f > 0 %>
      <tr>
        <td>DESCONTO:</td>
        <td class="text-right">-<%= number_to_currency(@sale.discount) %></td>
      </tr>
    <% end %>

    <% if @sale.surcharge.to_f > 0 %>
      <tr>
        <td>ACRÉSCIMO:</td>
        <td class="text-right">+<%= number_to_currency(@sale.surcharge) %></td>
      </tr>
    <% end %>

    <tr class="bold">
      <td style="font-size: 14px;">TOTAL FINAL:</td>
      <td class="text-right" style="font-size: 14px;"><%= number_to_currency(@sale.total) %></td>
    </tr>
  </table>
  
  <div class="dashed"></div>
  
  <div class="text-center bold">PAGAMENTO: <%= @sale.payment_method&.upcase || "N/A" %></div>
  
  <div class="dashed"></div>
  
  <div class="text-center bold italic">OBRIGADO PELA PREFERÊNCIA!</div>
  <div class="text-center bold italic">ESTE CUPOM NÃO TEM VALOR FISCAL!</div>
  <div class="text-center footer">Sistema de Gestão Comercial - 2026</div>

</body>
</html>